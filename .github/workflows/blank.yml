name: Build Mac Client
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake 3.29
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.29.x'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          brew install pkg-config openssl@3
          
      - name: Build slipstream-client (with auto picoquic build)
        env:
          OPENSSL_ROOT_DIR: /opt/homebrew/opt/openssl@3
          OPENSSL_DIR: /opt/homebrew/opt/openssl@3
          PKG_CONFIG_PATH: /opt/homebrew/opt/openssl@3/lib/pkgconfig
          # Don't set PICOQUIC_AUTO_BUILD=0, let cargo auto-build it
        run: |
          # Show OpenSSL location
          echo "OpenSSL location: $(brew --prefix openssl@3)"
          
          # Update env vars with actual brew prefix (in case it's different)
          export OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
          export OPENSSL_DIR=$(brew --prefix openssl@3)
          export PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig
          
          # Let cargo auto-build picoquic
          cargo build --release -p slipstream-client

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-client-mac
          path: target/release/slipstream-client
